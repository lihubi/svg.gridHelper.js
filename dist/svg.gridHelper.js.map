{"version":3,"file":"svg.gridHelper.js","sources":["../src/svg.gridHelper.js"],"sourcesContent":["import { Svg, SVG, extend } from '@svgdotjs/svg.js'\n\nclass GridHelper {\n  draw\n  options\n  gridGroup\n  labelGroup\n  visible\n  labelTemplate\n  parentDraw\n  constructor(parentDraw, options) {\n    this.parentDraw = parentDraw // 保存父绘图引用\n\n    // 创建一个新的 SVG DOM 并添加到父容器中\n    const parentDom = parentDraw.node.parentNode\n    const width = parentDraw.width()\n    const height = parentDraw.height()\n    // parentDom设置position为relative\n    parentDom.style.position = 'relative'\n    this.draw = SVG().addTo(parentDom).size(width, height).css({\n      position: 'absolute',\n      top: '0',\n      left: '0',\n      'z-index': '1', // 确保在父元素之上\n      'pointer-events': 'none', // 穿透交互事件\n    })\n\n    // 默认配置\n    this.options = Object.assign(\n      {\n        gridSize: 100,\n        minPixels: 100,\n        gridColor: 'gray',\n        labelColor: '#666',\n        gridStrokeWidth: 1,\n        labelFontSize: 12,\n      },\n      options,\n    )\n\n    // 创建标签模板\n    this.labelTemplate = this.draw.text('').hide()\n\n    // 创建网格和标签组\n    this.gridGroup = this.draw.group()\n    this.labelGroup = this.draw.group()\n\n    // 初始网格状态\n    this.visible = true\n\n    // 初始化网格\n    this.update()\n\n    //   setInterval(() => {\n    //     this.update();\n    //   }, 200);\n  }\n\n  // 计算合适的网格间距\n  calculateGridSize() {\n    const zoom = this.draw.zoom()\n    const minPixels = this.options.minPixels\n    const baseGridSize = this.options.gridSize\n\n    // 根据缩放级别调整网格间距\n    let gridSize = baseGridSize\n    while (gridSize * zoom < minPixels) {\n      gridSize *= 2\n    }\n    while (gridSize * zoom > minPixels * 2) {\n      gridSize /= 2\n    }\n\n    return Math.max(gridSize, 5) // 确保最小网格尺寸\n  }\n\n  // 更新网格和标签\n  update() {\n    // 清除旧的网格和标签\n    this.gridGroup.clear()\n\n    if (!this.visible) return\n\n    // 从 parentDraw 获取同步参数\n    const zoom = this.parentDraw.zoom()\n    const viewbox = this.parentDraw.viewbox()\n\n    // 使用 parentDraw 的 viewbox 设置当前 draw\n    this.draw.viewbox(viewbox.x, viewbox.y, viewbox.width, viewbox.height)\n    this.draw.zoom(zoom)\n\n    const gridSize = this.calculateGridSize()\n\n    // 获取当前视口位置\n    const viewX = viewbox.x\n    const viewY = viewbox.y\n    const viewWidth = viewbox.width\n    const viewHeight = viewbox.height\n\n    // 计算网格起点和终点\n    const startX = (Math.floor(viewX / gridSize) - 5) * gridSize\n    const endX = (Math.ceil((viewX + viewWidth) / gridSize) + 5) * gridSize\n    const startY = (Math.floor(viewY / gridSize) - 5) * gridSize\n    const endY = (Math.ceil((viewY + viewHeight) / gridSize) + 5) * gridSize\n\n    // 绘制网格线\n    for (let x = startX; x <= endX; x += gridSize) {\n      this.gridGroup.line(x, startY, x, endY).stroke({\n        width: this.options.gridStrokeWidth / zoom,\n        color: this.options.gridColor,\n        opacity: 0.7,\n      })\n    }\n\n    for (let y = startY; y <= endY; y += gridSize) {\n      this.gridGroup.line(startX, y, endX, y).stroke({\n        width: this.options.gridStrokeWidth / zoom,\n        color: this.options.gridColor,\n        opacity: 0.7,\n      })\n    }\n\n    // 绘制刻度标签\n    this.drawLabels(gridSize, viewX, viewY, viewWidth, viewHeight)\n  }\n\n  // 绘制标签\n  drawLabels(gridSize, viewX, viewY, viewWidth, viewHeight) {\n    const labelFontSize = this.options.labelFontSize\n\n    // 创建标签缓存对象\n    const existingLabels = new Map()\n    this.labelGroup.children().forEach((label) => {\n      const position = label.attr('position')\n      const key = `${position}-${label.text()}`\n      existingLabels.set(key, label)\n    })\n\n    // 创建/更新标签的公共方法\n    const updateOrCreateLabel = (\n      text,\n      x,\n      y,\n      anchor,\n      baseline,\n      fontSize,\n      position,\n    ) => {\n      const key = `${position}-${text}`\n      if (existingLabels.has(key)) {\n        const label = existingLabels.get(key)\n        label.font('size', fontSize).move(x, y)\n        existingLabels.delete(key) // 标记为已使用\n      } else {\n        this.createLabel(text, x, y, anchor, baseline, fontSize, position)\n      }\n    }\n\n    // 计算网格起点和终点\n    const startX = (Math.floor(viewX / gridSize) - 5) * gridSize\n    const endX = (Math.ceil((viewX + viewWidth) / gridSize) + 5) * gridSize\n    const startY = (Math.floor(viewY / gridSize) - 5) * gridSize\n    const endY = (Math.ceil((viewY + viewHeight) / gridSize) + 5) * gridSize\n\n    //根据zoom缩放文字大小\n    const zoom = this.draw.zoom()\n    const scale = 1 / zoom\n    // const fontSize = labelFontSize * scale; //设置字体大小\n    const fontSize = labelFontSize * scale //设置字体大小\n    const singleNumberWidth = this.getNumberWidth()\n\n    // 上边缘标签\n    for (let x = startX; x <= endX; x += gridSize) {\n      const screenX = x\n      const textWidth = x.toString().length * singleNumberWidth\n      // this.createLabel(x.toString(), screenX - textWidth / 2, viewY, 'middle', 'auto', fontSize);\n      updateOrCreateLabel(\n        x.toString(),\n        screenX - textWidth / 2,\n        viewY,\n        'middle',\n        'auto',\n        fontSize,\n        'top',\n      )\n    }\n\n    // // 下边缘标签\n    for (let x = startX; x <= endX; x += gridSize) {\n      const screenX = x\n      const textWidth = x.toString().length * singleNumberWidth\n      // this.createLabel(x.toString(), screenX - textWidth / 2, viewHeight - fontSize + viewY, 'middle', 'auto', fontSize);\n      updateOrCreateLabel(\n        x.toString(),\n        screenX - textWidth / 2,\n        viewHeight - fontSize + viewY,\n        'middle',\n        'auto',\n        fontSize,\n        'bottom',\n      )\n    }\n\n    // 左边缘标签\n    for (let y = startY; y <= endY; y += gridSize) {\n      const screenY = y\n      // this.createLabel(y.toString(), viewX, screenY - fontSize / 2, 'start', 'middle', fontSize);\n      updateOrCreateLabel(\n        y.toString(),\n        viewX,\n        screenY - fontSize / 2,\n        'start',\n        'middle',\n        fontSize,\n        'left',\n      )\n    }\n\n    // 右边缘标签\n    for (let y = startY; y <= endY; y += gridSize) {\n      const screenY = y\n      const textWidth = y.toString().length * singleNumberWidth\n      // this.createLabel(y.toString(), viewWidth + viewX - textWidth, screenY - fontSize / 2, 'end', 'middle', fontSize);\n      updateOrCreateLabel(\n        y.toString(),\n        viewWidth + viewX - textWidth,\n        screenY - fontSize / 2,\n        'end',\n        'middle',\n        fontSize,\n        'right',\n      )\n    }\n\n    // 删除未使用的旧标签\n    existingLabels.forEach((label) => label.remove())\n  }\n\n  // 创建标签元素\n  createLabel(text, x, y, anchor, baseline, fontSize, position) {\n    const label = this.labelTemplate\n      .clone()\n      .text(text)\n      .font({\n        size: fontSize,\n        family: 'Arial, sans-serif',\n      })\n      .fill(this.options.labelColor)\n      .attr({\n        'text-anchor': anchor,\n        'dominant-baseline': baseline,\n        'pointer-events': 'none',\n        style: 'user-select: none;',\n        position,\n      })\n      .move(x, y)\n      .show()\n\n    this.labelGroup.add(label)\n\n    // 将标签置于背景之上\n    label.front()\n  }\n\n  // 显示/隐藏网格\n  toggle(visible) {\n    if (visible !== undefined) {\n      this.visible = visible\n    } else {\n      this.visible = !this.visible\n    }\n\n    if (this.visible) {\n      this.gridGroup.show()\n      this.labelGroup.show()\n      this.update()\n    } else {\n      this.gridGroup.hide()\n      this.labelGroup.hide()\n    }\n  }\n\n  // 更新配置\n  updateOptions(options) {\n    Object.assign(this.options, options)\n    this.update()\n  }\n\n  //计算单个数字宽度\n  getNumberWidth() {\n    //根据zoom缩放文字大小\n    const zoom = this.draw.zoom()\n    const scale = 1 / zoom\n    const labelFontSize = this.options.labelFontSize\n    const fontSize = labelFontSize * scale //设置字体大小\n    // 创建临时文本测量\n    const tempText = this.labelTemplate.clone().text('0').font('size', fontSize)\n\n    // 获取文本边界框\n    const bbox = tempText.bbox()\n    // 立即移除临时元素\n    tempText.remove()\n    return bbox.width\n  }\n\n  resize() {}\n\n  destroy() {\n    this.gridGroup.remove()\n    this.labelGroup.remove()\n  }\n}\n\nextend(Svg, {\n  gridHelper(options) {\n    const gridHelper = new GridHelper(this, options)\n    this.gridHelper = gridHelper\n    return this\n  },\n})\n"],"names":["GridHelper","parentDraw","options","__publicField","parentDom","width","height","SVG","zoom","minPixels","gridSize","viewbox","viewX","viewY","viewWidth","viewHeight","startX","endX","startY","endY","x","y","labelFontSize","existingLabels","label","key","updateOrCreateLabel","text","anchor","baseline","fontSize","position","scale","singleNumberWidth","screenX","textWidth","screenY","visible","tempText","bbox","svg_js","Svg","gridHelper"],"mappings":"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"}